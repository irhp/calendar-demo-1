<!DOCTYPE html>
<html ng-app="calendarApp">
	<head>
		<link href="bootstrap.css" rel="stylesheet" />
		<link href="bootstrap-theme.css" rel="stylesheet" />
		<link href='fullcalendar.css' rel='stylesheet' />
		<link href='scheduler.css' rel='stylesheet' />
		<script src='../columns/moment.min.js'></script>
		<script src='../columns/jquery.min.js'></script>
		<script src='fullcalendar.js'></script>
		<script src='scheduler.js'></script>
		<script src='angular.min.js'></script>
		<script src='calendar.js'></script>
		<script>
			var app = angular.module('calendarApp', ['ui.calendar']);
			app.controller('calendarCtrl', function($scope, uiCalendarConfig) {
				var refresh = function() {
					//Change the view back and forth to force an update
					var viewName = uiCalendarConfig.calendars.theCalendar.fullCalendar('getView').name;
					uiCalendarConfig.calendars.theCalendar.fullCalendar('changeView',
						'month');
					uiCalendarConfig.calendars.theCalendar.fullCalendar('changeView',
						viewName);
					$scope.selectedEvent = undefined;
				}

				var updateEvent = function(source, value) {
					//Update the event information in the original database
					for(var i = 0; i < source.length; ++i) {
						if(source[i].id === value.id) {
							for(var x in value) {
								if(value.hasOwnProperty(x)) {
									source[i][x] = value[x];
								}
							}
						}
					}

					console.log(eventArray);
				};

				$scope.selectedEvent = undefined;

				$scope.commitChange = function() {
					$scope.selectedEvent.title = $scope.editorTitle;
					updateEvent(eventArray,$scope.selectedEvent);
					$scope.selectedEvent = undefined;
				};

				$scope.deleteEvent = function() {
					var se = $scope.selectedEvent;
					for(var i = 0; i < eventArray.length; ++i) {
						if(eventArray[i].id === se.id) {
							eventArray.splice(i,1);
							break;
						}
					}
					$scope.selectedEvent = undefined;
				};

				eventArray =  [
					{
						id: 'id1',
						title: 'The event',
						start: '2015-10-18T10:00:00',
						end: '2015-10-18T12:00:00',
						resourceId: 'A1'
					}
				];

				resourceArray = [
					{
						id: 'A1',
						title: 'Resource #1'
					},
					{
						id: 'A2',
						title: 'Resource #2'
					}
				];

				$scope.resourceArray = resourceArray;

				var nextId = 1;

				$scope.eventSources = [ eventArray ];
				$scope.uiConfig = {
					calendar: {
						defaultView: 'timelineCustom',
						editable: true,
						resources: resourceArray,
						dayClick: function(date, jsEvent, view, resource) {
							var newEvent = {
								id: ('kuter' + nextId++),
								title: 'New event',
								start: date.format(),
								end: date.add(3,'hour').format(),
								resourceId: resource.id
							};

							eventArray.push(newEvent);
						},
						eventClick: function(event, jsEvent, view) {
							$scope.selectedEvent = event;
							$scope.editorTitle = event.title;
						},
						eventDrop(event, delta, revertFunc, jsEvent, ui, view) {
							updateEvent(eventArray, event);
						},
						eventResize(event, delta, revertFunc, jsEvent, ui, view) {
							updateEvent(eventArray, event);
						},
						header: {
							left: 'timelineCustom month',
							center: 'title',
							right: 'today prev,next'
						},
						views: {
							timelineCustom: {
								type: 'timeline',
								duration: {
									days: 5
								}
							}
						}
					}
				};

				var nextResourceId = 3;

				$scope.addResource = function() {
					resourceArray.push({
						id: 'Resource' + nextResourceId,
						title: 'Resource #' + nextResourceId++
					});
				};

				$scope.removeResource = function() {
					resourceArray.pop();
				};

				$scope.addDay = function() {
					if($scope.uiConfig.calendar.views.timelineCustom.duration.days < 10) {
						++$scope.uiConfig.calendar.views.timelineCustom.duration.days;
					}
				};

				$scope.removeDay = function() {
					if($scope.uiConfig.calendar.views.timelineCustom.duration.days > 1) {
						--$scope.uiConfig.calendar.views.timelineCustom.duration.days;
					}
				};
			});
		</script>
	</head>
	<body ng-controller="calendarCtrl">
		<div class="container">
			<div class="row">
				<div class="col-xs-4">
				
					<div class="panel panel-default">
						<div class="panel-heading">
							Number of resources
						</div>
						<div class="panel-body text-center">
							<form class="form-horizontal">
								<button class="btn btn-default" ng-click="removeResource()"> &lt </button>
								<span> {{resourceArray.length}} </span>
								<button class="btn btn-default" ng-click="addResource()" /> &gt </button>
							</form>
						</div>
					</div>

					<div class="panel panel-default">
						<div class="panel-heading">
							Number of days
						</div>
						<div class="panel-body text-center">
							<form class="form-horizontal">
								<button class="btn btn-default" ng-click="removeDay()"> &lt </button>
								<span> {{uiConfig.calendar.views.timelineCustom.duration.days}} </span>
								<button class="btn btn-default" ng-click="addDay()" /> &gt </button>
							</form>
						</div>
					</div>

					<div ng-show="selectedEvent !== undefined" class="panel panel-default">
						<div class="panel-heading">
							Event ID 
						</div>
						<div class="panel-body text-center">
							<form>
								<div class="form-group">
									<input class="form-control" ng-model="editorTitle">
								</div>
								<div class="form-group">
									<button class="btn btn-default" ng-click="commitChange()">Commit</button>
									<button class="btn btn-default" ng-click="deleteEvent()">Delete event</button>
								</div>
							</form>
						</div>
					</div>

				</div>
				<div class="col-xs-8">
					<div ui-calendar="uiConfig.calendar" ng-model="eventSources" calendar='theCalendar'>
				</div>
			</div>
		</div>
	</body>
</html>
